"""Markdown newsletter composer."""
from typing import Optional

from app.models.digest import Digest
from app.models.domain_config import DomainConfig


class MarkdownComposer:
    """Compose Markdown newsletters from digests."""

    async def compose(self, digest: Digest, domain_config: Optional[DomainConfig] = None) -> str:
        """Compose a Markdown newsletter."""

        # Default branding values
        newsletter_title = "Science Digest Newsletter"
        app_name = "Science Digest"

        # Override with domain config if provided
        if domain_config:
            newsletter_title = domain_config.newsletter_title
            app_name = domain_config.app_name

        lines = []

        # Header
        lines.append(f"# {digest.name}")
        lines.append("")
        lines.append(f"*{newsletter_title}*")
        lines.append("")
        lines.append("---")
        lines.append("")
        
        # Intro
        if digest.intro_text:
            lines.append(digest.intro_text)
            lines.append("")
            lines.append("---")
            lines.append("")
        
        # Papers
        for i, dp in enumerate(digest.digest_papers, 1):
            paper = dp.paper
            
            # Headline
            headline = paper.summary_headline or paper.title
            lines.append(f"## {i}. {headline}")
            lines.append("")
            
            # Meta
            meta_parts = []
            if paper.journal:
                meta_parts.append(f"**Journal:** {paper.journal}")
            if paper.authors:
                authors = ", ".join(a.name for a in paper.authors[:3])
                meta_parts.append(f"**Authors:** {authors}")
            if paper.is_preprint:
                meta_parts.append("âš ï¸ *Preprint*")
            
            if meta_parts:
                lines.append(" | ".join(meta_parts))
                lines.append("")
            
            # Image
            if paper.image_path:
                lines.append(f"![{headline}]({paper.image_path})")
                lines.append("")
            
            # Takeaway
            if paper.summary_takeaway:
                lines.append(paper.summary_takeaway)
                lines.append("")
            
            # Why it matters
            if paper.summary_why_matters:
                lines.append(f"> {paper.summary_why_matters}")
                lines.append("")
            
            # Credibility
            if paper.credibility_score is not None:
                score = round(paper.credibility_score)
                if score >= 70:
                    emoji = "ğŸŸ¢"
                elif score >= 50:
                    emoji = "ğŸŸ¡"
                else:
                    emoji = "ğŸ”´"
                
                lines.append(f"**Credibility Score:** {emoji} {score}/100")
                if paper.credibility_note:
                    lines.append(f"*{paper.credibility_note}*")
                lines.append("")
            
            # Tags
            if paper.tags:
                tags_str = " ".join(f"`{tag}`" for tag in paper.tags)
                lines.append(f"**Tags:** {tags_str}")
                lines.append("")
            
            # Link
            if paper.url:
                lines.append(f"[Read full paper â†’]({paper.url})")
                lines.append("")
            
            lines.append("---")
            lines.append("")
        
        # Conclusion
        if digest.conclusion_text:
            lines.append(digest.conclusion_text)
            lines.append("")
        
        # Footer
        lines.append("---")
        lines.append("")
        lines.append(f"*Generated by {app_name}*")

        return "\n".join(lines)
